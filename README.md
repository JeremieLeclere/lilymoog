
# lilymoog

**lilymoog** is an Unix command line application that offers the possibility to generate an output WAV file, containing a monophonic track.

That track is generated following user configuration & instructions, both of them provided as input files to the **lilymoog** application, and through the use of a Moog like synthesizer.


## 1. Application overview

Here is the description of **lilymoog** usage:

	lilymoog -c CONFIG -s SCRIPT [-o OUTPUT_FILE] [-p PREFILL] [-P POSTFILL]

	Moog sequence generator using provided script and configuration

	 -c CONFIG
	    Moog synthesizer configuration and sequence tempo. Please refer to README.md
	    for more details about configurable parameters.

	 -s SCRIPT
	    Sequence to be generated, written in lilypond like syntax. Please refer to README.md
	    for more details about syntax.

	 -o OUTPUT_FILE
	    Output WAV filename (default: 'output.wav')

	 -p PREFILL
	    Prefill generated file with silence.
	    The value must be an positive int value, which will be interpreted as a number of
	    sixteenth notes. The equivalent duration of silence will be inserted at the
	    beginning of generated output file.

	 -P POSTFILL
	    Postfill generated file with silence.
	    The value must be an positive int value, which will be interpreted as a number of
	    sixteenth notes. The equivalent duration of silence will be inserted at the
	    end of generated output file.
	    That option is particularly useful when provided sequence does not ends with a
	    silence: It allows Moog synthesizer to be turned OFF, and let it produce output
	    until its release time has been reached (simply said: No click at the end of your
	    sequence, caused by a brutal interruption of sound data).


## 2. Configuration file

The configuration file, referred to as CONFIG in usage description, allows user to set some general settings for WAV file generation.

### Syntax
* Each settings is expected to be specified with a simple [key]=[value] line,
* [key] can take any of the following section items,
* Each settings has its own default value if not provided,
* One settings specification per line,
* You can insert comments in the file, by starting your line with a #

### Available settings

Following settings can be adressed via the configuration file:

_general settings_
* tempo :
	* Sequence "speed", in BPM (Beats Per Minute)
	* Default value: 94
* fs :
	* Sampling frequency of the generated output file, in Hz
	* Default value: 48kHz

_Moog low pass filter settings (*)_
* lp_fc :
	* Low pass filter cutoff frequency, in Hz
	* Must be positive and strictly inferior to fs/2
	* Default value: 400 Hz
* lp_Q :
	* Low pass filter quality factor, no unity
	* Must be positive
	* Default value: 1.5
* lp_gain :
	* Low pass filter gain, in dB
	* Default value: 1 dB

_Moog ADSR settings (*)_
* attack_time :
	* Attack time, in ms
	* Must be positive
	* Default value: 25 ms
* decay_time :
	* Decay time, in ms
	* Must be positive or null
	* Default value: 15 ms
* sustain :
	* Sustain factor, no unity
	* Must be in ]0,1]
	* The intensity parameter sets the maximum value reached during attack time, which is then progressively scaled during decay phase, until being scaled to the sustain factor scale
	* Default value: 0.7
* release_time :
	* Release time, in ms
	* Must be positive
	* Default value: 10 ms

_Moog oscillators settings (*)_
* waveform :
	* Oscillators waveform, provided as a string
	* Must be in ["saw", "sine", "square"]
	* Default value: "saw"
* coupling :
	* Oscillators coupling
	* Must be in ["none", "third_minor", "third_major", "fifth", "octave"]
	* The first oscillator will always play requested note, while the second one will play a note with a greater frequency determined by the interval specified
	* If "none" is selected, then only the first oscillator will be used
	* Default value: "fifth"
* intensity :
	* Intensity level of each oscillator
	* Must be in ]0,1]
	* At the time this README.md file is written, the intensity handling is nearly inexistant in application. Please consider giving a particular attention to this settings if things are not running as you expect ... And start by reducing it !

(*) Please refer to the Moog synthesizer structure section to get further details and more understandings about the Moog-like synthesizer used in **lilymoog**.

## 3. Script syntax

The script file, referred to as SCRIPT in usage description, is a file used to describe the notes sequence to be generated by **lilymoog**

The syntax has been defined in a way that is inspired by Lilypond concepts (http://lilypond.org/index.fr.html), obviously in a far more simple way :)

### Events

The sequence file can be considered as a list of events that will modify the Moog synthesizer state according to user expectations regarding the generated sequence.
In other words: User shall add an event for each new note or silence, with optional additional Moog state updates, to describe the sequence to be generated.

The event syntax must respect the followin syntax:

	[NOTE_NAME][OCTAVE_UPDATE][NOTE_LENGTH_UPDATE][ADDITIONAL_UPDATES]

* The 3 first fields refer to the note to be generated itself,
* The last field allows to update Moog low pass filter parameters,
* Every specified update is applied to the current event.

### Notes and rests

		[NOTE_NAME]

* The note name indicates Moog synthesizer to either play a given note, either "produce silence",
* To play a note, this field must be in ["a", "b", "c", "d", "e", "f", "g"],
* Each of this values can be suffixed with a "b" (for 'bémol' (\*)) or a "d" (for 'dièse' (\*)). Eg: "bb" for a b lower by a half tone,
* If set to "r", that will produce a rest,
* That field is the only **mandatory** field

(\*) Sorry for that 'bémol' and 'dièse', let's say that I couldn't get rid of that french words so far ...

		[OCTAVE_UPDATE]
* If set, that field will switch octave:
	* Use a combination of N ' characters to switch N octaves up,
	* Use a combination of N , characters to switch N octaves down.
* That field is **optional**: If not set, Moog synthesizer will keep previous defined octave,
* The reachable octaves ranks are in [0,8],
* Default value (ie: at the beginning ot the script): 4 (like in "A4" @ 440 Hz).

		[NOTE_LENGTH_UPDATE]

* If set, that field will modifiy notes/rests length,
* Available values are in [1, 2, 4, 8, 16], with exactly the same meaning as the denominator in standard music metre definition (https://en.wikipedia.org/wiki/Metre_(music)). ie: the 16 value corresponds to a sixteenth note length at the specified *tempo* configuration setting,
* This field is **optional**: If not set, Moog synthesizer will keep previous note/rest length,
* Default value (ie: at the beginning of the script): 4.

### Additional actions

	[ADDITIONAL_UPDATES]

* The additional section allows user to control the Moog synthesizer low pass filter parameters,
* The additional section is **optional**,
* The additional section starts with a [ and end with a ],
* The additional section can contain one of several directives:
	* Each directive must be written respecting following syntax: [key]:[value],
	* Consecutive directives must be separated by a comma, without space.
* The [key] field can take any of the following values:
	* "q" : Update low pass filter Q factor,
	* "fc" : Update low pass filter cutoff frequency,
	* "gain" : Update low pass filter gain,
	* "fcs" : Sweep low pass filter cutoff frequency to specified new value, on note duration.
* The [value] contents are constrained, exactly as in configuration file, according to the adressed parameter.

### Example

Since that would be quite a pain to start with just a list of rules, let's take a short example !

	e8[fc:1000,q:5]  b, d16[fcs:200] e r 

* e8[fc:1000]
	* First note is an E,
	* No octave update specified => We stay to default one,
	* Length update is indicated => That will be an 8th note,
	* Two additional updates specified:
		* Set Moog low pass filter cutoff frequency to 1000 Hz,
		* Set Moog low pass filter quality factor to 5.
* b,
	* Second note is a B,
	* There's a ",", so that will be the B an octave lower than previously
	* Length unchanged,
	* No Moog low pass filter update.
* d16[fcs:200]
	* Third note is a D,
	* No octave update specified => We stay to current one,
	* Length update is indicated => That will be a 16th note,
	* Moog filter low pass filter cutoff frequency will progressively switch to 200 Hz during note.
* e
	* Fourth note is an E,
	* No other parameter is changed: 16th note, with Moog low pass filter frequency set to 200 Hz, and still having a quality factor set to 5.
* r
	* Last "note" is a rest,
	* Nothing else changed, so that will be a rest with a 16th note duration.

Hope that helps !

## 4. Moog synthesizer structure

The Moog like synthesizer used in this aplication is built with the following structure:
### Oscillators
One or two oscillators (according to the *coupling* configuration setting) produce samples that are summed before entering the ADSR module.

Following waveforms are available:
* Saw : https://en.wikipedia.org/wiki/Sawtooth_wave
* Sine : https://en.wikipedia.org/wiki/Sine_wave
* Square : https://en.wikipedia.org/wiki/Square_wave

So far, the two oscillators will use the same waveform.

### ADSR
The sum of oscillators outputs is then sent to the ADSR (Attack/Decay/Sustain/Release) module.

For more details about that envelopppe control function, please refer to https://en.wikipedia.org/wiki/Envelope_(music).

### Low pass filter

Final step consists in a 2nd order low pass filter, implemented by a biquad (https://en.wikipedia.org/wiki/Digital_biquad_filter).

Some of the biquad parameters are really interesting to play with, and shall be considered by the user as a good way to expand rendering possibilities of **lilymoog**:

* Cutoff frequency : The frequency at which the -3dB attenuation is reach (https://en.wikipedia.org/wiki/Cutoff_frequency)
* Quality factor : A parameter that controls the smoothness of the filter, or can even create some peak around cutoff frequency if above 1/sqrt(2) (~0.707) (https://en.wikipedia.org/wiki/Q_factor)

## 5. Provided example files

You'll find a *script.txt* file and a *config.txt* file in the repository, don't hesitate to have a look to those and start playing with **lilymoog** from that basis !

Enjoy, and please let me know for any bug or feature idea ;)
